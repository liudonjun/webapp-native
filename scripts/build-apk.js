#!/usr/bin/env node

/**
 * APKç¼–è¯‘è„šæœ¬
 * åŠŸèƒ½ï¼š
 * 1. åˆ‡æ¢åˆ°Androidç›®å½•
 * 2. æ‰§è¡ŒGradleæ„å»ºå‘½ä»¤
 * 3. å¤„ç†ç­¾åï¼ˆReleaseç‰ˆæœ¬ï¼‰
 * 4. å¤åˆ¶APKåˆ°è¾“å‡ºç›®å½•
 */

// åŠ è½½ç¯å¢ƒå˜é‡
require('dotenv').config();

const fs = require('fs');
const path = require('path');
const os = require('os');
const { execSync } = require('child_process');

const config = require('../build.config.js');

// è·å–Gradle wrapperå‘½ä»¤ï¼ˆè·¨å¹³å°æ”¯æŒï¼‰
function getGradleCommand() {
  const isWindows = os.platform() === 'win32';
  return isWindows ? 'gradlew.bat' : './gradlew';
}

console.log('ğŸ“± å¼€å§‹ç¼–è¯‘APK...\n');

// éªŒè¯Androidé¡¹ç›®å­˜åœ¨
function validateAndroidProject() {
  const androidDir = path.join(__dirname, '..', 'android');
  
  if (!fs.existsSync(androidDir)) {
    throw new Error('Androidç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ npm run init');
  }
  
  const buildGradlePath = path.join(androidDir, 'build.gradle');
  if (!fs.existsSync(buildGradlePath)) {
    throw new Error('Androidé¡¹ç›®ä¸å®Œæ•´ï¼Œè¯·å…ˆè¿è¡Œ npm run sync');
  }
  
  console.log('âœ… Androidé¡¹ç›®éªŒè¯é€šè¿‡');
}

// é…ç½®Android SDKè·¯å¾„åˆ°local.properties
function configureLocalProperties() {
  const androidDir = path.join(__dirname, '..', 'android');
  const localPropertiesPath = path.join(androidDir, 'local.properties');
  
  // æŸ¥æ‰¾Android SDKè·¯å¾„
  let sdkPath = process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT;
  
  if (!sdkPath) {
    // å°è¯•å¸¸è§çš„Android SDKä½ç½®
    const possibleSdkPaths = [
      path.join(os.homedir(), 'AppData', 'Local', 'Android', 'Sdk'), // Windowsé»˜è®¤ä½ç½®
      path.join(os.homedir(), 'Library', 'Android', 'sdk'), // macOSé»˜è®¤ä½ç½®
      path.join(os.homedir(), 'Android', 'Sdk'), // Linuxé»˜è®¤ä½ç½®
      'C:\\Users\\' + os.userInfo().username + '\\AppData\\Local\\Android\\Sdk', // Windowså®Œæ•´è·¯å¾„
    ];
    
    for (const possiblePath of possibleSdkPaths) {
      if (fs.existsSync(possiblePath) && fs.existsSync(path.join(possiblePath, 'platform-tools'))) {
        sdkPath = possiblePath;
        console.log(`ğŸ“¦ è‡ªåŠ¨æ£€æµ‹åˆ°Android SDK: ${sdkPath}`);
        break;
      }
    }
  }
  
  if (!sdkPath) {
    console.warn('âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°Android SDKè·¯å¾„');
    console.warn('   è¯·è®¾ç½®ANDROID_HOMEç¯å¢ƒå˜é‡ï¼Œæˆ–æ‰‹åŠ¨ç¼–è¾‘ android/local.properties');
    return;
  }
  
  // éªŒè¯SDKè·¯å¾„
  if (!fs.existsSync(path.join(sdkPath, 'platform-tools'))) {
    console.warn(`âš ï¸  è­¦å‘Š: Android SDKè·¯å¾„æ— æ•ˆ: ${sdkPath}`);
    return;
  }
  
  // å†™å…¥local.propertiesæ–‡ä»¶
  // Windowsè·¯å¾„éœ€è¦è½¬ä¹‰åæ–œæ 
  const escapedSdkPath = sdkPath.replace(/\\/g, '\\\\');
  
  const localPropertiesContent = `## This file is automatically generated by the build script.
## It contains the Android SDK location.
## Do not modify this file manually.

sdk.dir=${escapedSdkPath}
`;
  
  fs.writeFileSync(localPropertiesPath, localPropertiesContent);
  console.log(`âœ… å·²é…ç½®Android SDKè·¯å¾„: ${sdkPath}`);
}

// æ£€æŸ¥Android SDKç¯å¢ƒ
function checkAndroidSDK() {
  try {
    // æ£€æŸ¥ANDROID_HOMEç¯å¢ƒå˜é‡
    const androidHome = process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT;
    if (!androidHome) {
      console.warn('âš ï¸  è­¦å‘Š: æœªè®¾ç½®ANDROID_HOMEç¯å¢ƒå˜é‡');
      console.warn('   è¯·è®¾ç½®ANDROID_HOMEæŒ‡å‘Android SDKè·¯å¾„');
    } else {
      console.log(`âœ… Android SDKè·¯å¾„: ${androidHome}`);
    }
    
    // æ£€æŸ¥Javaç¯å¢ƒ
    let javaHome = process.env.JAVA_HOME;
    let javaFound = false;
    
    // éªŒè¯JAVA_HOMEè·¯å¾„æ˜¯å¦å­˜åœ¨
    if (javaHome) {
      const javaExe = path.join(javaHome, 'bin', os.platform() === 'win32' ? 'java.exe' : 'java');
      if (!fs.existsSync(javaExe)) {
        console.warn(`âš ï¸  JAVA_HOMEè·¯å¾„æ— æ•ˆ: ${javaHome}`);
        console.warn('   å°è¯•è‡ªåŠ¨æ£€æµ‹Javaç¯å¢ƒ...');
        javaHome = null; // é‡ç½®ï¼Œè®©è„šæœ¬è‡ªåŠ¨æ£€æµ‹
      }
    }
    
    // å¦‚æœJAVA_HOMEæœªè®¾ç½®æˆ–æ— æ•ˆï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹
    if (!javaHome) {
      const possibleJavaPaths = [];
      
      // macOS: ä½¿ç”¨ /usr/libexec/java_home å‘½ä»¤æ£€æµ‹
      if (os.platform() === 'darwin') {
        try {
          const detectedJavaHome = execSync('/usr/libexec/java_home', {
            stdio: 'pipe',
            encoding: 'utf8'
          }).trim();
          if (detectedJavaHome && fs.existsSync(detectedJavaHome)) {
            possibleJavaPaths.push(detectedJavaHome);
          }
        } catch (error) {
          // /usr/libexec/java_home ä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•å…¶ä»–è·¯å¾„
        }
        
        // macOS: Android Studio è‡ªå¸¦çš„ JDK
        possibleJavaPaths.push(
          '/Applications/Android Studio.app/Contents/jbr',
          path.join(os.homedir(), 'Library', 'Android', 'sdk', 'jbr')
        );
      }
      
      // Windows: Android Studio è‡ªå¸¦çš„ JDK
      if (os.platform() === 'win32') {
        possibleJavaPaths.push(
          'C:\\Program Files\\Android\\Android Studio\\jbr',
          'C:\\Program Files (x86)\\Android\\Android Studio\\jbr',
          path.join(os.homedir(), 'AppData', 'Local', 'Android', 'Sdk', 'jbr')
        );
      }
      
      // Linux: å¸¸è§ JDK è·¯å¾„
      if (os.platform() === 'linux') {
        possibleJavaPaths.push(
          '/usr/lib/jvm/java-17-openjdk',
          '/usr/lib/jvm/java-11-openjdk',
          '/usr/lib/jvm/default-java'
        );
      }
      
      // éå†å¯èƒ½çš„è·¯å¾„
      for (const javaPath of possibleJavaPaths) {
        const javaExe = path.join(javaPath, 'bin', os.platform() === 'win32' ? 'java.exe' : 'java');
        if (fs.existsSync(javaExe)) {
          javaHome = javaPath;
          console.log(`ğŸ“¦ è‡ªåŠ¨æ£€æµ‹åˆ°Java SDK: ${javaHome}`);
          // ä¸´æ—¶è®¾ç½®JAVA_HOMEï¼ˆä»…å½“å‰è¿›ç¨‹ï¼‰
          process.env.JAVA_HOME = javaHome;
          break;
        }
      }
    }
    
    // æ£€æŸ¥Javaæ˜¯å¦å¯ç”¨
    try {
      const javaCmd = javaHome 
        ? path.join(javaHome, 'bin', os.platform() === 'win32' ? 'java.exe' : 'java')
        : 'java';
      
      const javaVersion = execSync(`"${javaCmd}" -version`, { 
        stdio: 'pipe',
        encoding: 'utf8'
      });
      
      if (javaHome) {
        console.log(`âœ… Javaç¯å¢ƒæ£€æŸ¥é€šè¿‡: ${javaHome}`);
      } else {
        console.log('âœ… Javaç¯å¢ƒæ£€æŸ¥é€šè¿‡');
      }
      javaFound = true;
    } catch (error) {
      // Javaå‘½ä»¤æ‰§è¡Œå¤±è´¥
    }
    
    if (!javaFound) {
      console.warn('âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°Javaç¯å¢ƒ');
      console.warn('   è¯·è®¾ç½®JAVA_HOMEç¯å¢ƒå˜é‡ï¼Œæˆ–ç¡®ä¿Android Studioå·²å®‰è£…');
      console.warn('   å‚è€ƒæ–‡æ¡£: docs/JAVA_SETUP.md');
    }
    
  } catch (error) {
    console.warn(`âš ï¸  ç¯å¢ƒæ£€æŸ¥è­¦å‘Š: ${error.message}`);
  }
}

// æ›´æ–°Androidé…ç½®
function updateAndroidConfig() {
  const androidDir = path.join(__dirname, '..', 'android');
  const appBuildGradlePath = path.join(androidDir, 'app', 'build.gradle');
  
  if (!fs.existsSync(appBuildGradlePath)) {
    console.warn('âš ï¸  æ— æ³•æ‰¾åˆ°app/build.gradleï¼Œè·³è¿‡é…ç½®æ›´æ–°');
    return;
  }
  
  try {
    let buildGradleContent = fs.readFileSync(appBuildGradlePath, 'utf8');
    
    // ç¡®ä¿ defaultConfig å—å­˜åœ¨ï¼ˆé˜²æ­¢è¢«æ„å¤–åˆ é™¤ï¼‰
    if (!buildGradleContent.includes('defaultConfig')) {
      console.warn('âš ï¸  æ£€æµ‹åˆ° build.gradle ç¼ºå°‘ defaultConfig å—ï¼Œæ­£åœ¨æ¢å¤...');
      // åœ¨ signingConfigs ä¹‹åã€buildTypes ä¹‹å‰æ’å…¥ defaultConfig
      buildGradleContent = buildGradleContent.replace(
        /(signingConfigs\s*\{[^}]*?\}[^}]*?)(buildTypes)/s,
        `$1\n    defaultConfig {\n        applicationId "${config.appId}"\n        minSdkVersion rootProject.ext.minSdkVersion\n        targetSdkVersion rootProject.ext.targetSdkVersion\n        versionCode ${config.version ? (() => { const m = config.version.match(/^(\d+)\.(\d+)\.(\d+)/); return m ? parseInt(m[1]) * 10000 + parseInt(m[2]) * 100 + parseInt(m[3]) : 10000; })() : 10000}\n        versionName "${config.version || '1.0.0'}"\n        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"\n        aaptOptions {\n             ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'\n        }\n    }\n    \n    $2`
      );
      console.log('âœ… å·²æ¢å¤ defaultConfig å—');
    }
    
    // æ›´æ–°åº”ç”¨ID
    buildGradleContent = buildGradleContent.replace(
      /applicationId\s+["'][^"']+["']/,
      `applicationId "${config.appId}"`
    );
    
    // æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¦‚æœé…ç½®ä¸­æœ‰ï¼‰
    if (config.version) {
      const versionMatch = config.version.match(/^(\d+)\.(\d+)\.(\d+)/);
      if (versionMatch) {
        const [, major, minor, patch] = versionMatch;
        buildGradleContent = buildGradleContent.replace(
          /versionCode\s+\d+/,
          `versionCode ${parseInt(major) * 10000 + parseInt(minor) * 100 + parseInt(patch)}`
        );
        buildGradleContent = buildGradleContent.replace(
          /versionName\s+["'][^"']+["']/,
          `versionName "${config.version}"`
        );
      }
    }
    
    // æ›´æ–°minSdkVersionï¼ˆæ”¯æŒ rootProject.ext.minSdkVersion æ ¼å¼ï¼‰
    if (config.android.minSdkVersion) {
      // å…ˆå°è¯•æ›¿æ¢ rootProject.ext.minSdkVersion æ ¼å¼
      if (buildGradleContent.includes('rootProject.ext.minSdkVersion')) {
        // æ›´æ–° variables.gradle æ–‡ä»¶
        const variablesGradlePath = path.join(androidDir, 'variables.gradle');
        if (fs.existsSync(variablesGradlePath)) {
          let variablesContent = fs.readFileSync(variablesGradlePath, 'utf8');
          variablesContent = variablesContent.replace(
            /minSdkVersion\s*=\s*\d+/,
            `minSdkVersion = ${config.android.minSdkVersion}`
          );
          fs.writeFileSync(variablesGradlePath, variablesContent);
          console.log(`âœ… å·²æ›´æ–° variables.gradle: minSdkVersion = ${config.android.minSdkVersion}`);
        }
      } else {
        // å¦‚æœä½¿ç”¨ç›´æ¥æ•°å€¼ï¼Œåˆ™æ›¿æ¢
        buildGradleContent = buildGradleContent.replace(
          /minSdkVersion\s+\d+/,
          `minSdkVersion ${config.android.minSdkVersion}`
        );
      }
    }
    
    // æ›´æ–°targetSdkVersionï¼ˆæ”¯æŒ rootProject.ext.targetSdkVersion æ ¼å¼ï¼‰
    if (config.android.targetSdkVersion) {
      // å…ˆå°è¯•æ›¿æ¢ rootProject.ext.targetSdkVersion æ ¼å¼
      if (buildGradleContent.includes('rootProject.ext.targetSdkVersion')) {
        // æ›´æ–° variables.gradle æ–‡ä»¶
        const variablesGradlePath = path.join(androidDir, 'variables.gradle');
        if (fs.existsSync(variablesGradlePath)) {
          let variablesContent = fs.readFileSync(variablesGradlePath, 'utf8');
          variablesContent = variablesContent.replace(
            /targetSdkVersion\s*=\s*\d+/,
            `targetSdkVersion = ${config.android.targetSdkVersion}`
          );
          fs.writeFileSync(variablesGradlePath, variablesContent);
          console.log(`âœ… å·²æ›´æ–° variables.gradle: targetSdkVersion = ${config.android.targetSdkVersion}`);
        }
      } else {
        // å¦‚æœä½¿ç”¨ç›´æ¥æ•°å€¼ï¼Œåˆ™æ›¿æ¢
        buildGradleContent = buildGradleContent.replace(
          /targetSdkVersion\s+\d+/,
          `targetSdkVersion ${config.android.targetSdkVersion}`
        );
      }
    }
    
    // æ›´æ–°compileSdkVersionï¼ˆæ”¯æŒ rootProject.ext.compileSdkVersion æ ¼å¼ï¼‰
    if (config.android.compileSdkVersion) {
      if (buildGradleContent.includes('rootProject.ext.compileSdkVersion')) {
        const variablesGradlePath = path.join(androidDir, 'variables.gradle');
        if (fs.existsSync(variablesGradlePath)) {
          let variablesContent = fs.readFileSync(variablesGradlePath, 'utf8');
          variablesContent = variablesContent.replace(
            /compileSdkVersion\s*=\s*\d+/,
            `compileSdkVersion = ${config.android.compileSdkVersion}`
          );
          fs.writeFileSync(variablesGradlePath, variablesContent);
          console.log(`âœ… å·²æ›´æ–° variables.gradle: compileSdkVersion = ${config.android.compileSdkVersion}`);
        }
      }
    }
    
    // é…ç½®ç­¾åï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (config.signing && config.signing.enabled && config.buildMode === 'release') {
      const keystorePath = path.resolve(__dirname, '..', config.signing.keystorePath);
      
      if (!fs.existsSync(keystorePath)) {
        throw new Error(`Keystoreæ–‡ä»¶ä¸å­˜åœ¨: ${keystorePath}`);
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰signingConfigsé…ç½®
      if (!buildGradleContent.includes('signingConfigs')) {
        // åœ¨androidå—ä¸­æ·»åŠ signingConfigs
        buildGradleContent = buildGradleContent.replace(
          /(android\s*\{[^}]*)(defaultConfig)/,
          `$1\n    signingConfigs {\n        release {\n            storeFile file('${path.relative(path.dirname(appBuildGradlePath), keystorePath).replace(/\\/g, '/')}')\n            storePassword '${config.signing.keystorePassword}'\n            keyAlias '${config.signing.keyAlias}'\n            keyPassword '${config.signing.keyPassword}'\n        }\n    }\n    $2`
        );
      } else {
        // æ›´æ–°ç°æœ‰çš„signingConfigs - ä½¿ç”¨æ›´ç²¾ç¡®çš„åŒ¹é…ï¼Œé¿å…ç ´åæ–‡ä»¶ç»“æ„
        // æ³¨æ„ï¼šä¸å†æ¸…ç†å¤§æ‹¬å·ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šè¯¯åˆ  defaultConfig å—çš„å…³é—­å¤§æ‹¬å·
        // å¦‚æœæ–‡ä»¶ç»“æ„æœ‰é—®é¢˜ï¼Œä¼šåœ¨åç»­çš„éªŒè¯å’Œä¿®å¤æ­¥éª¤ä¸­å¤„ç†
        
        // åŒ¹é…æ•´ä¸ªsigningConfigså—ï¼ˆåŒ…æ‹¬åµŒå¥—çš„releaseå—ï¼‰
        // ä½¿ç”¨éè´ªå©ªåŒ¹é…ï¼Œç¡®ä¿åªåŒ¹é…åˆ°signingConfigså—çš„ç»“æŸï¼Œä¸åŒ…å« defaultConfig
        // åŒ¹é… signingConfigs { ... } åé¢è·Ÿç€ç©ºç™½å’Œ defaultConfig æˆ– buildTypes
        const signingConfigsPattern = /(signingConfigs\s*\{[^}]*?release\s*\{[^}]*?\}[^}]*?\})(\s*(?:defaultConfig|buildTypes))/s;
        
        if (signingConfigsPattern.test(buildGradleContent)) {
          const newSigningConfigs = `signingConfigs {\n        release {\n            storeFile file('${path.relative(path.dirname(appBuildGradlePath), keystorePath).replace(/\\/g, '/')}')\n            storePassword '${config.signing.keystorePassword}'\n            keyAlias '${config.signing.keyAlias}'\n            keyPassword '${config.signing.keyPassword}'\n        }\n    }`;
          // ä½¿ç”¨æ•è·ç»„ä¿ç•™åé¢çš„ defaultConfig æˆ– buildTypes
          buildGradleContent = buildGradleContent.replace(signingConfigsPattern, `${newSigningConfigs}$2`);
        } else {
          console.warn('âš ï¸  æ— æ³•åŒ¹é…ç°æœ‰çš„signingConfigsé…ç½®ï¼Œè·³è¿‡æ›´æ–°');
        }
      }
      
      // åœ¨release buildTypeä¸­åº”ç”¨ç­¾åé…ç½®
      if (buildGradleContent.includes('buildTypes')) {
        if (!buildGradleContent.includes('signingConfig signingConfigs.release')) {
          buildGradleContent = buildGradleContent.replace(
            /(release\s*\{[^}]*)(minifyEnabled)/,
            `$1            signingConfig signingConfigs.release\n            $2`
          );
        }
      }
      
      console.log('âœ… ç­¾åé…ç½®å·²æ·»åŠ åˆ°build.gradle');
    }
    
    // ç­¾åé…ç½®æ›´æ–°åï¼Œå†æ¬¡ç¡®ä¿ defaultConfig å—å­˜åœ¨ï¼ˆé˜²æ­¢è¢«ç­¾åé…ç½®æ›´æ–°é€»è¾‘ç ´åï¼‰
    if (!buildGradleContent.includes('defaultConfig')) {
      console.warn('âš ï¸  ç­¾åé…ç½®æ›´æ–°åæ£€æµ‹åˆ° defaultConfig å—ç¼ºå¤±ï¼Œæ­£åœ¨æ¢å¤...');
      if (buildGradleContent.includes('signingConfigs') && buildGradleContent.includes('buildTypes')) {
        buildGradleContent = buildGradleContent.replace(
          /(signingConfigs\s*\{[^}]*?\}[^}]*?)(buildTypes)/s,
          `$1\n    defaultConfig {\n        applicationId "${config.appId}"\n        minSdkVersion rootProject.ext.minSdkVersion\n        targetSdkVersion rootProject.ext.targetSdkVersion\n        versionCode ${config.version ? (() => { const m = config.version.match(/^(\d+)\.(\d+)\.(\d+)/); return m ? parseInt(m[1]) * 10000 + parseInt(m[2]) * 100 + parseInt(m[3]) : 10000; })() : 10000}\n        versionName "${config.version || '1.0.0'}"\n        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"\n        aaptOptions {\n             ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'\n        }\n    }\n    \n    $2`
        );
        console.log('âœ… å·²æ¢å¤ defaultConfig å—');
      }
    }
    
    // éªŒè¯ defaultConfig å—æ˜¯å¦å®Œæ•´ï¼ˆåŒ…å«å¼€å§‹å’Œç»“æŸå¤§æ‹¬å·ï¼‰
    const defaultConfigMatch = buildGradleContent.match(/defaultConfig\s*\{[^}]*\}/s);
    const hasCompleteDefaultConfig = defaultConfigMatch !== null;
    
    if (!hasCompleteDefaultConfig && buildGradleContent.includes('defaultConfig')) {
      console.warn('âš ï¸  æ£€æµ‹åˆ° defaultConfig å—ä¸å®Œæ•´ï¼Œå°è¯•ä¿®å¤...');
      // å°è¯•ä¿®å¤ï¼šåœ¨ defaultConfig å—çš„ aaptOptions åæ·»åŠ å…³é—­å¤§æ‹¬å·
      buildGradleContent = buildGradleContent.replace(
        /(aaptOptions\s*\{[^}]*ignoreAssetsPattern[^}]*\})\s*(buildTypes)/s,
        `$1\n        }\n    }\n    \n    $2`
      );
    }
    
    fs.writeFileSync(appBuildGradlePath, buildGradleContent);
    console.log('âœ… Android build.gradleé…ç½®å·²æ›´æ–°');
    
    // æ›´æ–°åº”ç”¨åç§°ï¼ˆstrings.xmlï¼‰
    updateAppName();
  } catch (error) {
    console.warn(`âš ï¸  æ›´æ–°Androidé…ç½®å¤±è´¥: ${error.message}`);
  }
}

// æ›´æ–°Androidåº”ç”¨åç§°
function updateAppName() {
  const androidDir = path.join(__dirname, '..', 'android');
  const stringsXmlPath = path.join(androidDir, 'app', 'src', 'main', 'res', 'values', 'strings.xml');
  
  if (!fs.existsSync(stringsXmlPath)) {
    console.warn('âš ï¸  æ— æ³•æ‰¾åˆ°strings.xmlï¼Œè·³è¿‡åº”ç”¨åç§°æ›´æ–°');
    return;
  }
  
  try {
    let stringsXmlContent = fs.readFileSync(stringsXmlPath, 'utf8');
    
    // æ›´æ–°app_name
    stringsXmlContent = stringsXmlContent.replace(
      /<string name="app_name">[^<]+<\/string>/,
      `<string name="app_name">${config.appName}</string>`
    );
    
    // æ›´æ–°title_activity_main
    stringsXmlContent = stringsXmlContent.replace(
      /<string name="title_activity_main">[^<]+<\/string>/,
      `<string name="title_activity_main">${config.appName}</string>`
    );
    
    // æ›´æ–°package_nameï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (config.appId) {
      stringsXmlContent = stringsXmlContent.replace(
        /<string name="package_name">[^<]+<\/string>/,
        `<string name="package_name">${config.appId}</string>`
      );
      
      // æ›´æ–°custom_url_scheme
      stringsXmlContent = stringsXmlContent.replace(
        /<string name="custom_url_scheme">[^<]+<\/string>/,
        `<string name="custom_url_scheme">${config.appId}</string>`
      );
    }
    
    fs.writeFileSync(stringsXmlPath, stringsXmlContent);
    console.log(`âœ… Androidåº”ç”¨åç§°å·²æ›´æ–°: ${config.appName}`);
  } catch (error) {
    console.warn(`âš ï¸  æ›´æ–°åº”ç”¨åç§°å¤±è´¥: ${error.message}`);
  }
}

// æ‰§è¡ŒGradleæ„å»º
function buildAPK() {
  const androidDir = path.join(__dirname, '..', 'android');
  const buildType = config.buildMode === 'release' ? 'release' : 'debug';
  const gradleCmd = getGradleCommand();
  
  console.log(`ğŸ”¨ æ‰§è¡ŒGradleæ„å»º (${buildType})...`);
  console.log(`   å¹³å°: ${os.platform()}`);
  console.log(`   Gradleå‘½ä»¤: ${gradleCmd}`);
  
  // æ£€æŸ¥å¹¶ä¿®å¤ gradlew æ‰§è¡Œæƒé™ï¼ˆmacOS/Linuxï¼‰
  if (os.platform() !== 'win32' && gradleCmd === './gradlew') {
    const gradlewPath = path.join(androidDir, 'gradlew');
    if (fs.existsSync(gradlewPath)) {
      try {
        const stats = fs.statSync(gradlewPath);
        // æ£€æŸ¥æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ï¼ˆæ£€æŸ¥ owner execute bitï¼‰
        const mode = stats.mode;
        const executeBit = 0o111; // æ‰§è¡Œæƒé™ä½
        if ((mode & executeBit) === 0) {
          console.log('ğŸ”§ æ£€æµ‹åˆ° gradlew ç¼ºå°‘æ‰§è¡Œæƒé™ï¼Œæ­£åœ¨ä¿®å¤...');
          fs.chmodSync(gradlewPath, '755'); // æ·»åŠ æ‰§è¡Œæƒé™: rwxr-xr-x
          console.log('âœ… å·²ä¿®å¤ gradlew æ‰§è¡Œæƒé™');
        }
      } catch (error) {
        console.warn(`âš ï¸  æ— æ³•æ£€æŸ¥ gradlew æƒé™: ${error.message}`);
      }
    }
  }
  
  try {
    // æ¸…ç†ä¹‹å‰çš„æ„å»º
    console.log('ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º...');
    execSync(`${gradleCmd} clean`, {
      stdio: 'inherit',
      cwd: androidDir,
      shell: os.platform() === 'win32' // Windowséœ€è¦shell
    });
    
    // æ„å»ºAPK
    const buildCommand = buildType === 'release' 
      ? `${gradleCmd} assembleRelease` 
      : `${gradleCmd} assembleDebug`;
    
    console.log(`ğŸ“¦ æ‰§è¡Œæ„å»ºå‘½ä»¤: ${buildCommand}`);
    execSync(buildCommand, {
      stdio: 'inherit',
      cwd: androidDir,
      shell: os.platform() === 'win32' // Windowséœ€è¦shell
    });
    
    console.log(`âœ… Gradleæ„å»ºå®Œæˆ (${buildType})`);
    
  } catch (error) {
    throw new Error(`Gradleæ„å»ºå¤±è´¥: ${error.message}`);
  }
}

// å¤åˆ¶APKåˆ°è¾“å‡ºç›®å½•
function copyAPK() {
  const androidDir = path.join(__dirname, '..', 'android');
  const buildType = config.buildMode === 'release' ? 'release' : 'debug';
  const apkSourceDir = path.join(
    androidDir, 
    'app', 
    'build', 
    'outputs', 
    'apk', 
    buildType
  );
  
  if (!fs.existsSync(apkSourceDir)) {
    throw new Error(`APKè¾“å‡ºç›®å½•ä¸å­˜åœ¨: ${apkSourceDir}`);
  }
  
  const apkFiles = fs.readdirSync(apkSourceDir).filter(file => file.endsWith('.apk'));
  if (apkFiles.length === 0) {
    throw new Error('æœªæ‰¾åˆ°APKæ–‡ä»¶');
  }
  
  // åˆ›å»ºè¾“å‡ºç›®å½•
  const outputDir = path.join(__dirname, '..', config.outputDir);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }
  
  // å¤åˆ¶APKæ–‡ä»¶
  apkFiles.forEach(apkFile => {
    const sourcePath = path.join(apkSourceDir, apkFile);
    const destPath = path.join(outputDir, apkFile);
    
    fs.copyFileSync(sourcePath, destPath);
    console.log(`âœ… å¤åˆ¶APK: ${apkFile}`);
    
    // æ˜¾ç¤ºæ–‡ä»¶å¤§å°
    const stats = fs.statSync(destPath);
    const sizeInMB = (stats.size / 1024 / 1024).toFixed(2);
    console.log(`   æ–‡ä»¶å¤§å°: ${sizeInMB} MB`);
  });
  
  console.log(`\nâœ… APKæ–‡ä»¶å·²å¤åˆ¶åˆ°: ${config.outputDir}`);
}

// ä¸»å‡½æ•°
function main() {
  try {
    validateAndroidProject();
    checkAndroidSDK();
    configureLocalProperties(); // é…ç½®local.properties
    updateAndroidConfig();
    buildAPK();
    copyAPK();
    
    console.log('\nâœ… APKç¼–è¯‘æµç¨‹å®Œæˆï¼');
    console.log(`\nğŸ“¦ APKæ–‡ä»¶ä½ç½®: ${path.join(__dirname, '..', config.outputDir)}`);
  } catch (error) {
    console.error('\nâŒ ç¼–è¯‘å¤±è´¥:', error.message);
    console.error('\næç¤º:');
    console.error('1. ç¡®ä¿å·²å®‰è£…Android SDKå’ŒAndroid Studio');
    console.error('2. ç¡®ä¿å·²è®¾ç½®ANDROID_HOMEç¯å¢ƒå˜é‡');
    console.error('3. ç¡®ä¿å·²å®‰è£…JDK 11+');
    console.error('4. å¦‚æœæ˜¯Releaseç‰ˆæœ¬ï¼Œè¯·é…ç½®ç­¾åä¿¡æ¯');
    process.exit(1);
  }
}

main();

